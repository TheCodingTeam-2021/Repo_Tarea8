// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace Tarea8_App.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using System.Net.Http.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using System.ComponentModel.DataAnnotations;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Tarea8_App;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Tarea8_App.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Newtonsoft.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using System.Text.Json.Serialization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using System.Net;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Radzen;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\_Imports.razor"
using Radzen.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\Pages\RegistrarVacunado.razor"
using Tarea8_App.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\Pages\RegistrarVacunado.razor"
using System.Data.SqlClient;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\Pages\RegistrarVacunado.razor"
using Microsoft.Data.Sqlite;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\Pages\RegistrarVacunado.razor"
using Microsoft.EntityFrameworkCore;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/RegistrarVacunado")]
    public partial class RegistrarVacunado : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 89 "C:\Users\marti\Source\Repos\TheCodingTeam-2021\Repo_Tarea8\Tarea8_App\Pages\RegistrarVacunado.razor"
      
    // Variables al utilizar en el codigo.
    bool exits;
    string Mensaje;
    int dia, mes;
    string MesString;
    string DiaString;

    // Instancia de la clase del Models Vacunados donde se guardaran los Registro.
    Vacunados vc = new Vacunados();

    // Lista de los vacunados con Where, para saber si existe el registro.
    List<Vacunados> GetVacunados() => new Tarea8Context().Vacunados.Where(v => v.Cedula == vc.Cedula).ToList();

    // Lista la cual se usara para carga los datos del select.
    List<Vacunas> GetVacunas() => new Tarea8Context().Vacunas.ToList();

    // Mapeo del Json de la API.
    public class Root {
        public string Cedula { get; set; }
        public string Nombres { get; set; }
        public string Apellido1 { get; set; }
        public String Apellido2 { get; set; }
        public string FechaNacimiento { get; set; }
        public string LugarNacimiento { get; set; }
        public int IDCategoria { get; set; }
        public string IdSexo { get; set; }
        public string IdEstadoCivil { get; set; }
        public int IdOcupacion { get; set; }
        public int IDNacionalidad { get; set; }
        public int IDMunicipio { get; set; }
        public int IDColegio { get; set; }
        public object IDCausaCancelacion { get; set; }
        public string IDEstatus { get; set; }
        public string EstatusCedulaAzul { get; set; }
        public string CedulaAnterior { get; set; }
        public string mun_ced { get; set; }
        public string seq_ced { get; set; }
        public string ver_ced { get; set; }
        public object V2004 { get; set; }
        public object V2008 { get; set; }
        public object V2012 { get; set; }
        public object V2016 { get; set; }
        public object PLD { get; set; }
        public object PRD { get; set; }
        public object PRSC { get; set; }
        public object PRM { get; set; }
        public object Multiplicador_NombreCompleto { get; set; }
        public object Multiplicador_Cedula { get; set; }
        public object Simpatia_Descripcion { get; set; }
        public object Ilocalizable { get; set; }
        public object Apodo { get; set; }
        public object PadronLF { get; set; }
        public bool ok { get; set; }
        public string foto { get; set; }
    }

    // Instancia de la clase del Mapeo del Json.
    Root Persona = new Root();

    // Metodos para Buscar y validar la cedula a traves de la API.
    async Task FindPerson(){
        // cargando variable con el Json de la API.
        Persona = await Http.GetFromJsonAsync<Root>("https://api.adamix.net/apec/cedula/"+vc.Cedula);

        // Condicion para saber que la variable con el Json esta cargada y contiene los datos del cliente
        if(Persona.ok){

            // Con este foreach conocemos si el vacunado ya existe.
            foreach (var item in @GetVacunados()){
                exits = true;
            }

            // Condicion en caso de que la cedula esta registrada.
            if(exits==true){
                Mensaje="Paciente Ya Con la Primera Vacuna!";

                // Conexion manual a la base de datos para el metodo raw de guardar la segunda fecha.
                SqliteConnection cone;

                // connetion string.
                cone = new SqliteConnection(@"Data Source= Data//Tarea8.db");

                // Abriendo la conexion.
                cone.Open();

                // Cargando la variable con el dato que se va a guardar.
                vc.FechaSdosis = DateTime.Now.ToString("yyyy-MM-dd");

                // Sentencia de sql para el proceso de update.
                var query = "UPDATE Vacunados SET Fecha_SDosis = '"+vc.FechaSdosis+"' Where Cedula =" + vc.Cedula;

                // Creando nuevo comando al cual le pasamos la conexion y la sentencia.
                SqliteCommand command = new SqliteCommand(query, cone);

                using (Tarea8Context cmd_SegundaDosis = new Tarea8Context())
                {
                    // Ejecutar sentencia.
                    cmd_SegundaDosis.Database.ExecuteSqlRaw(query, vc.Cedula);
                }

                // Cerrando la conexion
                cone.Close();

                // Mensaje del estado del proceso.
                Mensaje="El Paciente ya estaba Registrado, por lo Cual se le registro la Segunda Dosis!";
                // Llamada al metodo para restar la cedula.

            }
            // De caso contrario se le cargaran estos datos a las variables.
            else{
                vc.Nombre = Persona.Nombres;
                vc.Apellido = Persona.Apellido1 + " " + Persona.Apellido2;
                vc.FechaNacimiento = Persona.FechaNacimiento.Substring(0,10);
                vc.FechaPdosis = DateTime.Now.ToString("yyyy-MM-dd");
                

                //Cargando en variables los contenidos de la fecha.
                MesString =Persona.FechaNacimiento.Substring(5,2);
                mes = int.Parse(MesString);
                DiaString =Persona.FechaNacimiento.Substring(8,2);
                dia = int.Parse(DiaString);

                //Con esos contenidos los analizaremos para saber cual es su Signo Zodiacal.
                if((dia>=21&&mes==3)||(dia<=20&&mes==4)){
                    vc.SignoZodiacal =  "Aries";
                }

                else if((dia>=24&&mes==9)||(dia<=23&&mes==10)){
                    vc.SignoZodiacal =  "Libra";
                }

                else if((dia>=21&&mes==4)||(dia<=21&&mes==5)){
                    vc.SignoZodiacal = "Tauro";
                }

                else if((dia>=24&&mes==10)||(dia<=22&&mes==11)){
                    vc.SignoZodiacal = "Escorpio";
                }

                else if((dia>=22&&mes==5)||(dia<=21&&mes==6)){
                    vc.SignoZodiacal = "Geminis";
                }

                else if((dia>=23&&mes==11)||(dia<=21&&mes==12)){
                    vc.SignoZodiacal = "Sagitario";
                }

                else if((dia>=21&&mes==6)||(dia<=23&&mes==7)){
                    vc.SignoZodiacal = "Cancer";
                }

                else if((dia>=22&&mes==12)||(dia<=20&&mes==1)){
                    vc.SignoZodiacal = "Capricornio";
                }

                else if((dia>=24&&mes==7)||(dia<=23&&mes==8)){
                    vc.SignoZodiacal = "Leo";
                }

                else if((dia>=21&&mes==1)||(dia<=19&&mes==2)){
                    vc.SignoZodiacal = "Acuario";
                }

                else if((dia>=24&&mes==8)||(dia<=23&&mes==9)){
                    vc.SignoZodiacal = "Virgo";
                }

                else if((dia>=20&&mes==2)||(dia<=20&&mes==3)){
                    vc.SignoZodiacal = "Piscis";
                }

                // Llamada a metodo Restar Vacuna.
                //RestarVacuna();

            }
        }
        // De caso contrario que no se encuentre datos se mostrara este mensaje.
        else{
            Mensaje="Cedula No Encontrada...";
        }
    }

    // Metodo para registrar registrados.
    void AddPerson(){
        using (Tarea8Context cmd_Insert = new Tarea8Context())
        {
            if(vc.Cedula == null){
                Mensaje="Debe Lenar el Campo Cedula!";

            }
            else{
                cmd_Insert.Add(vc);
                RestarVacuna();
                cmd_Insert.SaveChanges();
                Clear();
                Mensaje="Paciente Vacunado!";
            }
        }
    }

    // Metodo para limpiar los campos.
    void Clear(){
        vc.Cedula = null;
        vc.Nombre = "";
        vc.Apellido = "";
        vc.FechaNacimiento = "";
        vc.Provincia = "";
        vc.SignoZodiacal = "";
        vc.Telefono = "";
        vc.FechaPdosis="";
        vc.FechaSdosis="";
        vc.MarcaVacuna="";
        vc.Lalitud="";
        vc.Longitud="";
        Mensaje = "";

    }

    // Metodo Para restar las Vacunas.
    void RestarVacuna(){
        // Conexion manual a la base de datos para restar vacuna del inventario.
        SqliteConnection con;

        // connetion string.
        con = new SqliteConnection(@"Data Source= Data//Tarea8.db");

        // Abriendo la conexion.
        con.Open();

        // Sentencia de sql para el proceso de update.
        var query = "UPDATE Vacunas SET Cantidad = Cantidad - 1 WHERE Marca = '"+vc.MarcaVacuna+"'";

        // Creando nuevo comando al cual le pasamos la conexion y la sentencia.
        SqliteCommand commandd = new SqliteCommand(query, con);

        using (Tarea8Context cmd_Inventario = new Tarea8Context())
        {
            // Ejecutar sentencia.
            cmd_Inventario.Database.ExecuteSqlRaw(query, vc.MarcaVacuna);
        }

        // Cerrando la conexion
        con.Close();

        // Mensaje del estado del proceso.
        Mensaje = "Inventario actualizado";
    }


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private HttpClient Http { get; set; }
    }
}
#pragma warning restore 1591
